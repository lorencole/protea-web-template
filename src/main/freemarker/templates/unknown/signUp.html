<@page title="Sign Up">

<script> loadPageScript(function(page) {

		function passwordStrength() {
			if (! page.password()) {
				return null;
			}
			var a = [];
			a.push(page.emailAddress());
			return zxcvbn(page.password(), a);
		}
	
		page.message = ko.observable();
		page.emailAddress = ko.observable().extend({ required: true, email: true });
		page.firstName = ko.observable().extend({ required: true });
		page.lastName = ko.observable().extend({ required: true });
		page.password = ko.observable().extend({ required: true }).extend({
	        validation: { 
				validator: function (value, validate) {
					if (!validate) { return true; }
					return passwordStrength().score > 1;
				},
				message: 'Weak'
			},
		});
		page.confirm = ko.observable().extend({ required: true }).extend({  // custom validator
	        validation: { 
				validator: function (value, validate) {
					if (!validate) { return true; }
					if (! page.password.isValid()) { return true; }
					return value === page.password();
				},
				message: 'Mismatched'
			}
	    });
		page.passwordStrength = ko.computed(function() {
			if (! page.password()) {
				return null;
			}
			if (! page.password.isModified()) {
				return null;
			}
			var z = passwordStrength();
			var ret = {
				percentage: (20 + (z.score * 20)) + "%"
			};
			switch(z.score) {
			case 0: ret.message = 'poor'; ret.color = 'danger'; break;
			case 1: ret.message = 'weak'; ret.color = 'danger'; break;
			case 2: ret.message = 'fair'; ret.color = 'warning'; break;
			case 3: ret.message = 'good'; ret.color = 'success'; break;
			case 4: ret.message = 'strong'; ret.color = 'success'; break;
			}
			return ret;
		});

		page.signUp = function() {
			var temp = {
				emailAddress: page.emailAddress(),
				firstName: page.firstName(),
				lastName: page.lastName(),
				password: page.password()
			};
			app.ajax('POST', '/api/users/create', JSON.stringify(temp), function(response) {
				if (response && response.sessionToken) {
					localStorage.sessionToken = response.sessionToken;
					app.reloadCurrentUser();
				}
				if (response && response.message) {
					page.message(response.message);
				}
			});
		};

		page.isValid = ko.computed(function() {
			return page.emailAddress.isValid() &&
				page.firstName.isValid() &&
				page.lastName.isValid() &&
				page.password.isValid() && 
				page.confirm.isValid();
		});

}); </script>

<div class="login-box-body" data-bind="with: page">

	<p class="login-box-msg">Register a new membership</p>
	
	<div class="input-group form-group">
		<span class="input-group-addon" data-bind="css: { validationMessage : firstName.isModified() && ! firstName.isValid() }"><i class="fa fa-fw fa-user"></i></span> <input data-bind="textInput: firstName" type="text" class="form-control" name="firstName" placeholder="first name">
	</div>
	
	<div class="input-group form-group">
		<span class="input-group-addon" data-bind="css: { validationMessage : lastName.isModified() && ! lastName.isValid() }"><i class="fa fa-fw fa-user"></i></span> <input data-bind="textInput: lastName" type="text" class="form-control" name="lastName" placeholder="last name">
	</div>

	<div class="input-group form-group">
		<span class="input-group-addon" data-bind="css: { validationMessage : emailAddress.isModified() && ! emailAddress.isValid() }"><i class="fa fa-fw fa-envelope"></i></span> <input data-bind="textInput: emailAddress" type="text" class="form-control" name="username" placeholder="email address">
	</div>

	<div class="input-group form-group">
		<span class="input-group-addon" data-bind="css: { validationMessage : password.isModified() && ! password.isValid() }"><i class="fa fa-fw fa-lock"></i></span> <input data-bind="textInput: password" type="password" class="form-control" name="password" placeholder="Password">
	</div>

	<!-- ko if: passwordStrength() -->
	<div class="progress" style="margin-bottom: 10px" >
		<div class="progress-bar" role="progressbar"data-bind="style: { width: passwordStrength().percentage }, css: 'progress-bar-' + passwordStrength().color ">
			<span data-bind="text: passwordStrength().message"></span>
		</div>
	</div>
	<!-- /ko -->

	<div class="input-group form-group">
		<span class="input-group-addon" data-bind="css: { validationMessage : confirm.isModified() && ! confirm.isValid() }"><i class="fa fa-fw fa-lock"></i></span> <input data-bind="textInput: confirm" type="password" class="form-control" name="confirm" placeholder="Confirm Password">
	</div>
	
	<span class="login-box-msg warning" data-bind="text: message"></span>

	<div class="row">
		<div class="col-xs-8">
		</div>
		<div class="col-xs-4">
			<button type="submit" class="btn btn-primary btn-block btn-flat" data-bind="click: signUp, css: { invalid: ! isValid() }">Register</button>
		</div>
	</div>

	<div class="social-auth-links text-center">
		<p>- OR -</p>
		<a href="#" onclick="hello('facebook').login()" class="btn btn-block btn-social btn-facebook btn-flat"><i class="fa fa-facebook"></i> Sign up using Facebook</a>
		<a href="#" onclick="hello('twitter').login()" class="btn btn-block btn-social btn-twitter btn-flat"><i class="fa fa-twitter"></i> Sign up using Twitter</a>
		<a href="#" onclick="hello('google').login()" class="btn btn-block btn-social btn-google-plus btn-flat"><i class="fa fa-google-plus"></i>Sign up using Google</a>
	</div>

	<a href="#login.html" class="text-center">I already have a membership</a>

</div>

</@page>
